<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JoinMarket Fidelity Bond Simulator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #1a73e8;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #165db8;
        }
        .results {
            margin-top: 20px;
        }
        .loading {
            text-align: center;
            color: #777;
            margin: 20px 0;
            display: none;
        }
        .error {
            color: #d93025;
            margin: 10px 0;
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background-color: #f4f7fc;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a73e8;
            margin: 5px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #555;
        }
        .results-section {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f4f7fc;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f6f8fa;
        }
        .progress-bar-container {
            background-color: #e0e0e0;
            border-radius: 4px;
            height: 20px;
            margin-top: 5px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #1a73e8;
            width: 0;
        }
        .fidelity-bond-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f0fe;
            border-radius: 6px;
            border-left: 4px solid #1a73e8;
        }
        .fidelity-bond-info h3 {
            margin-top: 0;
            color: #1a73e8;
        }
        .fidelity-bond-info p {
            margin-bottom: 5px;
        }
        .calculator-section {
            background-color: #f4f7fc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }
        .no-bond {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>JoinMarket Fidelity Bond Simulator</h1>
    
    <div class="container">
        <div class="fidelity-bond-info">
            <h3>About This Tool</h3>
            <p>This simulator helps potential JoinMarket makers evaluate their competitive position in the market based on fidelity bonds.</p>
            <p>In JoinMarket, makers with stronger fidelity bonds are more likely to be selected for coinjoins, potentially earning more fees.</p>
            <p>Use this tool to determine what size fidelity bond you should create based on your competitive goals.</p>
        </div>
        
        <h2>Configuration</h2>
        <div class="config-section">
            <div>
                <div class="form-group">
                    <label for="numberOfMakers">Total participants in coinjoin (including taker):</label>
                    <input type="number" id="numberOfMakers" value="9" min="2" placeholder="9">
                </div>
                <div class="form-group">
                    <label for="absoluteFeeLimit">Absolute fee limit per participant (sats):</label>
                    <input type="number" id="absoluteFeeLimit" value="8000" min="0" placeholder="8000">
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label for="relativeFeeLimit">Relative fee limit (%):</label>
                    <input type="number" id="relativeFeeLimit" value="0.03" min="0" step="0.001" placeholder="0.03">
                </div>
                <div class="form-group">
                    <label for="coinjoinSize">Coinjoin size (sats):</label>
                    <input type="number" id="coinjoinSize" value="10000000" min="1000" placeholder="10,000,000">
                </div>
            </div>
        </div>
        
        <div class="calculator-section">
            <h3>Fidelity Bond Calculator</h3>
            <p>Calculate your fidelity bond value based on amount and lock time:</p>
            <div class="calculator-grid">
                <div class="form-group">
                    <label for="bondAmount">Amount to lock (sats):</label>
                    <input type="number" id="bondAmount" value="1000000" min="0" step="100000">
                </div>
                <div class="form-group">
                    <label for="lockTimeMonths">Lock time (months):</label>
                    <input type="number" id="lockTimeMonths" value="12" min="1" placeholder="12">
                </div>
                <div class="form-group">
                    <label for="calculatedBondValue">Calculated bond value (sats²):</label>
                    <input type="text" id="calculatedBondValue" readonly>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="fidelityBondValue">Your fidelity bond value (sats²):</label>
            <input type="number" id="fidelityBondValue" value="0" min="0">
            <div id="bondValueHint" class="hint"></div>
        </div>
        
        <button id="simulateBtn">Simulate Coinjoin</button>
        <div id="loading" class="loading">Loading orderbook data...</div>
        <div id="error" class="error"></div>
    </div>
    
    <div id="results" class="container results" style="display: none;">
        <h2>Simulation Results</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Orderbook Size</div>
                <div id="totalOrderbookSize" class="stat-value">0</div>
                <div class="stat-label">makers</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Size-Compatible Offers</div>
                <div id="sizeCompatibleOffers" class="stat-value">0</div>
                <div class="stat-label">makers</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Fee-Compatible Offers</div>
                <div id="feeCompatibleOffers" class="stat-value">0</div>
                <div class="stat-label">makers</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Offers with Bonds</div>
                <div id="offersWithBonds" class="stat-value">0</div>
                <div class="stat-label">makers</div>
            </div>
        </div>
        
        <div class="results-section">
            <h3>Probability of Being Selected</h3>
            <div class="fidelity-bond-info">
                <h3>How Selection Works</h3>
                <p>In JoinMarket, makers are selected in two ways:</p>
                <p>1. <strong>Random Selection:</strong> One maker is randomly chosen among all makers (1/n chance, where n is the number of makers).</p>
                <p>2. <strong>Bond-Based Selection:</strong> The remaining makers (n-1) are chosen proportionally to their fidelity bond values.</p>
                <p>The probabilities below reflect your chances in each selection method and your overall probability across a large number of coinjoins.</p>
            </div>
            
            <div class="stat-card">
                <div id="randomSelectionLabel" class="stat-label">Probability as Random Selection (1/n chance)</div>
                <div id="randomSelectionProbability" class="stat-value">0%</div>
                <div class="progress-bar-container">
                    <div id="randomSelectionBar" class="progress-bar"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div id="bondBasedSelectionLabel" class="stat-label">Probability as Bond-Based Selection ((n-1)/n chance)</div>
                <div id="bondBasedSelectionProbability" class="stat-value">0%</div>
                <div class="progress-bar-container">
                    <div id="bondBasedSelectionBar" class="progress-bar"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Overall Probability of Being Selected</div>
                <div id="overallProbability" class="stat-value">0%</div>
                <div class="progress-bar-container">
                    <div id="overallProbabilityBar" class="progress-bar"></div>
                </div>
            </div>
        </div>
        
        <div class="results-section">
            <h3>Filtered Orderbook (Fee and size compatible only)</h3>
            <p><em>Note: Offers without fidelity bonds are considered above but not included on the table</em></p>
            <table id="filteredOrderbook">
                <thead>
                    <tr>
                        <th>Counterparty</th>
                        <th>Min Size</th>
                        <th>Max Size</th>
                        <th>Fee Type</th>
                        <th>Fee</th>
                        <th>Fidelity Bond</th>
                        <th>Selection Weight</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        const simulateBtn = document.getElementById('simulateBtn');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const resultsEl = document.getElementById('results');
        const bondAmountEl = document.getElementById('bondAmount');
        const lockTimeMonthsEl = document.getElementById('lockTimeMonths');
        const calculatedBondValueEl = document.getElementById('calculatedBondValue');
        const fidelityBondValueEl = document.getElementById('fidelityBondValue');
        const bondValueHintEl = document.getElementById('bondValueHint');
        
        // Update the calculated bond value when inputs change
        function updateCalculatedBondValue() {
            const amount = parseFloat(bondAmountEl.value) || 0;
            const lockTimeMonths = parseInt(lockTimeMonthsEl.value) || 0;
            
            // Default parameters from JoinMarket configuration
            const interestRate = 0.015;
            const exponent = 1.3;
            
            // Current time in seconds
            const currentTimeSeconds = Math.floor(Date.now() / 1000);
            
            // Use current time as confirmation time
            const confirmTimeSeconds = currentTimeSeconds;
            
            // Calculate locktime by adding months to current time
            // Convert months to seconds (approximate)
            const secondsPerMonth = 30 * 24 * 60 * 60;
            const lockTimeSeconds = currentTimeSeconds + (lockTimeMonths * secondsPerMonth);
            
            // Calculate fidelity bond value using the formula from bond-calculator
            // Gregorian calendar year length in seconds
            const YEAR = 60 * 60 * 24 * 365.2425;
            
            // Calculate time locked in years
            const timeLockedYears = (lockTimeSeconds - currentTimeSeconds) / YEAR;
            
            // Apply the fidelity bond formula: amount * (e^(r*t) - 1) ^ exponent
            // where r is the interest rate, t is the time in years, and exponent is the bond value exponent
            const bondValueSats = Math.pow(amount * (Math.exp(interestRate * timeLockedYears) - 1), exponent);
            
            // Update the field with formatted value
            calculatedBondValueEl.value = formatNumber(Math.round(bondValueSats));
            
            // Also update the fidelity bond value field
            fidelityBondValueEl.value = Math.round(bondValueSats);
            fidelityBondValueEl.dataset.rawValue = Math.round(bondValueSats);
        }
        
        // Add event listeners to the calculator inputs
        bondAmountEl.addEventListener('input', updateCalculatedBondValue);
        lockTimeMonthsEl.addEventListener('input', updateCalculatedBondValue);
        
        // Initialize the calculated bond value
        updateCalculatedBondValue();
        
        simulateBtn.addEventListener('click', runSimulation);
        
        async function runSimulation() {
            // Reset UI
            errorEl.style.display = 'none';
            resultsEl.style.display = 'none';
            loadingEl.style.display = 'block';
            
            try {
                // Get configuration values
                const numberOfMakers = parseInt(document.getElementById('numberOfMakers').dataset.rawValue || document.getElementById('numberOfMakers').value) - 1; // Subtract 1 for taker
                const absoluteFeeLimit = parseInt(document.getElementById('absoluteFeeLimit').dataset.rawValue || document.getElementById('absoluteFeeLimit').value);
                const relativeFeeLimit = parseFloat(document.getElementById('relativeFeeLimit').dataset.rawValue || document.getElementById('relativeFeeLimit').value) / 100;
                const coinjoinSize = parseInt(document.getElementById('coinjoinSize').dataset.rawValue || document.getElementById('coinjoinSize').value);
                const yourFidelityBond = parseFloat(document.getElementById('fidelityBondValue').dataset.rawValue || document.getElementById('fidelityBondValue').value || 0);
                
                // Fetch orderbook data
                const orderbook = await fetchOrderbook();
                
                // Process orderbook data
                const results = processOrderbook(orderbook, {
                    numberOfMakers,
                    absoluteFeeLimit,
                    relativeFeeLimit,
                    coinjoinSize,
                    yourFidelityBond
                });
                
                // Display results
                displayResults(results);
                
                // Hide loading and show results
                loadingEl.style.display = 'none';
                resultsEl.style.display = 'block';
            } catch (error) {
                console.error('Error in simulation:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Error: ' + (error.message || 'Failed to run simulation');
                errorEl.style.display = 'block';
            }
        }
        
        async function fetchOrderbook() {
            try {
                const response = await fetch('orderbook.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch orderbook data');
                }
                const orderbook = await response.json();
                
                // Find the highest fidelity bond in the orderbook
                if (orderbook.offers && orderbook.offers.length > 0) {
                    const highestBond = orderbook.offers.reduce((max, offer) => {
                        return Math.max(max, offer.fidelity_bond_value || 0);
                    }, 0);
                    
                    // Update the hint text
                    if (highestBond > 0) {
                        bondValueHintEl.textContent = `Current highest bond in orderbook: ${formatNumber(highestBond)} sats`;
                        // If user hasn't input a value yet, suggest the highest bond
                        if (!fidelityBondValueEl.value) {
                            fidelityBondValueEl.value = formatNumber(highestBond);
                            fidelityBondValueEl.dataset.rawValue = highestBond;
                        }
                    }
                }
                return orderbook;
            } catch (error) {
                throw new Error('Failed to load orderbook: ' + error.message);
            }
        }
        
        function processOrderbook(orderbook, config) {
            const allOffers = orderbook.offers;
            const totalOffers = allOffers.length;
            
            // Filter offers based on size
            const sizeCompatibleOffers = allOffers.filter(offer =>
                offer.minsize <= config.coinjoinSize &&
                offer.maxsize >= config.coinjoinSize
            );
            
            // Filter offers based on fee
            const feeCompatibleOffers = sizeCompatibleOffers.filter(offer => {
                if (offer.ordertype === 'sw0absoffer') {
                    // Absolute fee
                    return offer.cjfee <= config.absoluteFeeLimit;
                } else if (offer.ordertype === 'sw0reloffer') {
                    // Relative fee
                    const relativeFee = parseFloat(offer.cjfee);
                    const calculatedFee = config.coinjoinSize * relativeFee;
                    return relativeFee <= config.relativeFeeLimit && calculatedFee <= config.absoluteFeeLimit;
                }
                return false;
            });
            
            // Count offers with bonds (but don't filter them out)
            const offersWithBondsCount = feeCompatibleOffers.filter(offer =>
                offer.fidelity_bond_value > 0
            ).length;
            
            // Calculate actual fee for each offer
            const offersWithFees = feeCompatibleOffers.map(offer => {
                let fee;
                if (offer.ordertype === 'sw0absoffer') {
                    fee = offer.cjfee;
                } else if (offer.ordertype === 'sw0reloffer') {
                    fee = config.coinjoinSize * parseFloat(offer.cjfee);
                }
                return {
                    ...offer,
                    calculatedFee: fee
                };
            });
            
            // Sort offers by fidelity bond value in descending order
            offersWithFees.sort((a, b) =>
                (b.fidelity_bond_value || 0) - (a.fidelity_bond_value || 0)
            );
            
            // Calculate bond-based selection probabilities
            // Use same exponent as in the bond calculation (1.3)
            const exponent = 1.3;
            const totalBondValue = feeCompatibleOffers.reduce((sum, offer) =>
                sum + (offer.fidelity_bond_value || 0), 0);
            const yourBondWeighted = config.yourFidelityBond;
            
            // Calculate probabilities based on number of makers configured
            const numMakers = config.numberOfMakers;
            const randomChance = 1 / numMakers; // One maker is selected randomly
            const bondChance = (numMakers - 1) / numMakers; // Remaining makers selected by bond weight
            
            // Calculate random selection probability
            let randomSelectionProbability = 0;
            if (feeCompatibleOffers.length > 0) {
                randomSelectionProbability = 1 / (feeCompatibleOffers.length + 1); // +1 for your offer
            }
            
            // Calculate bond-based selection probability
            let bondBasedSelectionProbability = 0;
            if (totalBondValue > 0 && config.yourFidelityBond > 0) {
                bondBasedSelectionProbability = yourBondWeighted / (totalBondValue + yourBondWeighted);
            }
            
            // Calculate overall probability - properly accounting for the two selection methods
            const randomComponentProbability = randomChance * randomSelectionProbability;
            const bondComponentProbability = bondChance * bondBasedSelectionProbability;
            const overallProbability = randomComponentProbability + bondComponentProbability;
            
            return {
                totalOffers,
                sizeCompatibleOffers: sizeCompatibleOffers.length,
                feeCompatibleOffers: feeCompatibleOffers.length,
                offersWithBonds: offersWithBondsCount,
                randomSelectionProbability,
                bondBasedSelectionProbability,
                randomComponentProbability,
                bondComponentProbability,
                overallProbability,
                filteredOffers: offersWithFees,
                totalBondValue,
                yourBondWeighted,
                randomChance,
                bondChance,
                numMakers
            };
        }
        
        function displayResults(results) {
            // Update statistics
            document.getElementById('totalOrderbookSize').textContent = formatNumber(results.totalOffers);
            document.getElementById('sizeCompatibleOffers').textContent = formatNumber(results.sizeCompatibleOffers);
            document.getElementById('feeCompatibleOffers').textContent = formatNumber(results.feeCompatibleOffers);
            document.getElementById('offersWithBonds').textContent = formatNumber(results.offersWithBonds);
            
            // Update probabilities
            const randomProb = document.getElementById('randomSelectionProbability');
            const bondProb = document.getElementById('bondBasedSelectionProbability');
            const overallProb = document.getElementById('overallProbability');
            
            // Update the probability labels to reflect the fraction based on number of makers
            const randomLabel = document.getElementById('randomSelectionLabel');
            const bondLabel = document.getElementById('bondBasedSelectionLabel');
            randomLabel.textContent = `Probability as Random Selection (1/${results.numMakers} chance)`;
            bondLabel.textContent = `Probability as Bond-Based Selection (${results.numMakers-1}/${results.numMakers} chance)`;
            
            const randomProbPercent = (results.randomComponentProbability * 100).toFixed(4);
            const bondProbPercent = (results.bondComponentProbability * 100).toFixed(4);
            const overallProbPercent = (results.overallProbability * 100).toFixed(4);
            
            randomProb.textContent = randomProbPercent + '%';
            bondProb.textContent = bondProbPercent + '%';
            overallProb.textContent = overallProbPercent + '%';
            
            // Update progress bars
            document.getElementById('randomSelectionBar').style.width = Math.min(randomProbPercent * 10, 100) + '%';
            document.getElementById('bondBasedSelectionBar').style.width = Math.min(bondProbPercent * 10, 100) + '%';
            document.getElementById('overallProbabilityBar').style.width = Math.min(overallProbPercent * 10, 100) + '%';
            
            // Update filtered orderbook table
            const tableBody = document.querySelector('#filteredOrderbook tbody');
            tableBody.innerHTML = '';
            results.filteredOffers.forEach(offer => {
                const row = document.createElement('tr');
                
                // Calculate this offer's weight in selection
                let selectionWeight = '0%';
                let bondValue = offer.fidelity_bond_value || 0;
                if (bondValue > 0 && results.totalBondValue > 0) {
                    selectionWeight = ((bondValue / results.totalBondValue) * 100).toFixed(2) + '%';
                } else{
                    // skip offers without bonds
                    return;
                }
                
                // Format fee display
                let feeDisplay;
                if (offer.ordertype === 'sw0absoffer') {
                    feeDisplay = formatNumber(offer.cjfee) + ' sats';
                } else {
                    feeDisplay = (parseFloat(offer.cjfee) * 100).toFixed(4) + '%';
                }
                
                row.innerHTML = `
                    <td>${offer.counterparty}</td>
                    <td>${formatNumber(offer.minsize)} sats</td>
                    <td>${formatNumber(offer.maxsize)} sats</td>
                    <td>${offer.ordertype === 'sw0absoffer' ? 'Absolute' : 'Relative'}</td>
                    <td>${feeDisplay}</td>
                    <td>${formatNumber(bondValue)}</td>
                    <td>${selectionWeight}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }
    });
    </script>
</body>
</html>
